// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"  
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users Table
model User {
  id           String             @id @default(uuid())
  name         String
  email        String             @unique
  passwordHash String
  avatarUrl    String?
  avatarId     String?
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")
  
  // Relations
  comments     Comment[]
  userRoles    UserRoleProject[]
  assignedTasks UserTask[]
  
  @@map("users")
}

// Roles Table
model Role {
  id          Int                @id @default(autoincrement())
  name        String             @unique
  description String?
  createdAt   DateTime           @default(now()) @map("created_at")
  
  // Relations
  userRoles   UserRoleProject[]
  
  @@map("roles")
}

// Projects Table
model Project {
  id          Int                @id @default(autoincrement())
  name        String
  description String?
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")
  
  // Relations
  tasks       Task[]
  userRoles   UserRoleProject[]
  
  @@map("projects")
}

// User-Role-Project Junction Table (Many-to-Many)
model UserRoleProject {
  id        Int      @id @default(autoincrement())
  userId    String   @map("user_id")
  roleId    Int      @map("role_id")
  projectId Int      @map("project_id")
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@unique([userId, roleId, projectId])
  @@map("user_role_project")
}

// Task Status Table
model TaskStatus {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  tasks     Task[]
  
  @@map("task_status")
}

// Task Priority Table
model TaskPriority {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  level     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  tasks     Task[]
  
  @@map("task_priority")
}

// Tasks Table
model Task {
  id          Int      @id @default(autoincrement())
  projectId   Int      @map("project_id")
  name        String
  description String?
  deadline    DateTime?
  statusId    Int      @map("status_id")
  priorityId  Int      @map("priority_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  project     Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  status      TaskStatus       @relation(fields: [statusId], references: [id])
  priority    TaskPriority     @relation(fields: [priorityId], references: [id])
  comments    Comment[]
  assignments UserTask[]
  taskTags    TaskTag[]
  
  @@map("tasks")
}

// Task Assignment Table (Many-to-Many between Task and User)
// User-Task assignment (user assigned to task)
model UserTask {
  id         Int      @id @default(autoincrement())
  taskId     Int      @map("task_id")
  userId     String   @map("user_id")
  assignedAt DateTime @default(now()) @map("assigned_at")

  // Relations
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@map("user_task")
}

// Tags and task-tags junction
model Tag {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  taskTags  TaskTag[]

  @@map("tags")
}

model TaskTag {
  id     Int  @id @default(autoincrement())
  taskId Int  @map("task_id")
  tagId  Int  @map("tag_id")

  task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tag    Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([taskId, tagId])
  @@map("task_tags")
}

// Comments Table
model Comment {
  id        Int      @id @default(autoincrement())
  taskId    Int      @map("task_id")
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("comments")
}
